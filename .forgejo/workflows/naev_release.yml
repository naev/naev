on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"
      - "!v*.*.*-alpha*"
      - "!v*.*.*-beta*"
      - "!v*.*.*-rc*"

name: Release

permissions: {}
jobs:
  "Package_Source":
    runs-on: naev-release
    steps:
      - name: Force Codeberg over SSH
        run: git config --global url."ssh://git@codeberg.org/naev/".insteadOf https://codeberg.org/naev/

      - name: Checkout Naev Repository
        uses: actions/checkout@v4
        with:
          lfs: false # restore after cache
          path: source
          submodules: true
          ssh-key: ${{ secrets.CODEBERG_SSH_KEY }}
          ssh-known-hosts: ${{ secrets.CODEBERG_SSH_KNOWN_HOSTS }}
          persist-credentials: false

      - name: Prefetch Meson subprojects
        run: |
          meson subprojects download --sourcedir source

      - name: Cache Meson wrap downloads
        uses: actions/cache@v3
        with:
          path: source/subprojects/packagecache
          key: wrap-${{ runner.os }}-${{ hashFiles('source/subprojects/*.wrap') }}
          restore-keys: wrap-${{ runner.os }}-

      - name: Capture assets submodule revision
        id: assets_rev
        run: echo "rev=$(git -C source submodule status assets | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Restore LFS cache
        uses: actions/cache@v3
        with:
          path: |
            source/.git/lfs/objects
            source/.git/modules/assets/lfs/objects
          key: lfs-${{ runner.os }}-${{ steps.assets_rev.outputs.rev }}
          restore-keys: lfs-${{ runner.os }}-

      - name: Fetch and checkout LFS
        run: |
          git -C source/assets lfs fetch --all
          git -C source/assets lfs checkout

      - name: Package Dist
        run: |
          meson setup build source -Dexecutable=disabled -Ddocs_c=disabled -Ddocs_lua=disabled --wrap-mode=forcefallback
          meson dist -C build --no-tests --include-subprojects

      - name: Collect Artifacts
        run: |
          mkdir -p build/dist
          cp -r source/utils/ci/itch source/utils/ci/steam source/utils/ci/berg build/dist/
          cp source/utils/buildAppImage.sh build/dist
          cp source/utils/buildUniversalBundle.sh build/dist
          cp -r source/extras/macos/dmg_assets build/dist
          cp source/extras/macos/entitlements.plist build/dist
          mv build/meson-dist/naev-*.tar.xz build/dist/source.tar.xz
          cp source/Changelog.md build/dist
          cp source/dat/VERSION build/dist

      - name: Upload Source Artifact
        uses: actions/upload-artifact@v3
        with:
          name: naev-dist
          path: ${{ github.workspace }}/build/dist/source.tar.xz
          if-no-files-found: error

      - name: Upload Changelog Artifact
        uses: actions/upload-artifact@v3
        with:
          name: naev-changelog
          path: ${{ github.workspace }}/build/dist/Changelog.md
          if-no-files-found: error
      - name: Upload Version Artifact
        uses: actions/upload-artifact@v3
        with:
          name: naev-version
          path: ${{ github.workspace }}/build/dist/VERSION
          if-no-files-found: error

      - name: Upload Packaging Assets
        uses: actions/upload-artifact@v3
        with:
          name: naev-packaging-assets
          path: |
            ${{ github.workspace }}/build/dist/buildAppImage.sh
            ${{ github.workspace }}/build/dist/buildUniversalBundle.sh
            ${{ github.workspace }}/build/dist/dmg_assets
            ${{ github.workspace }}/build/dist/entitlements.plist
          if-no-files-found: error
          include-hidden-files: true

      - name: Upload Deployment Assets
        uses: actions/upload-artifact@v3
        with:
          name: naev-deployment-assets
          path: |
            ${{ github.workspace }}/build/dist/berg
            ${{ github.workspace }}/build/dist/steam
            ${{ github.workspace }}/build/dist/itch
          if-no-files-found: error
          include-hidden-files: true

  "Linux_Naev_Release":
    needs: "Package_Source"
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: naev-steamruntime
            config: linux_steamruntime.ini
            wrap_mode: default
            target: x86_64-unknown-linux-gnu

    runs-on: ${{ matrix.image }}

    steps:
      - name: Get Source
        uses: actions/download-artifact@v3
        with:
          name: naev-dist

      - name: Extract Source
        run: |
          mkdir source
          tar -xf source.tar.xz -C source --strip 1

      - name: Cache Cargo home
        uses: actions/cache@v3
        with:
          path: build/cargo-home
          key: cargo-${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('source/Cargo.toml.in', 'source/meson.build') }}
          restore-keys: |
            cargo-${{ runner.os }}-${{ matrix.target }}-
            cargo-${{ runner.os }}-

      - name: Meson Setup
        run: |
          meson setup build source \
              --native-file='source/utils/build/linux_steamruntime.ini' \
              --buildtype=release \
              --wrap-mode=${{ matrix.wrap_mode }} \
              --force-fallback-for=sdl2_image,glpk,SuiteSparse \
              -Dsteamruntime=true \
              -Dprefix="/usr" \
              -Dinstaller=true \
              -Db_lto=true \
              -Dauto_features=enabled \
              -Ddocs_c=disabled \
              -Ddocs_lua=disabled

      - name: Meson Compile
        run: |
          meson compile -C build

      - name: Meson Install
        run: |
          meson install -C build
        env:
          DESTDIR: ${{ github.workspace }}/staging

      - name: Compile AppImage
        run: |
              ./source/utils/buildAppImage.sh -s source -b build

      - name: Collect Steam Linux64 Artifacts
        run: |
          mkdir -p build/dist/

          mv staging/usr/bin/naev build/dist/naev.x64
          chmod +x build/dist/naev.x64

          tar -cJvf build/dist/naev-appdir.tar.xz -C  build/dist/ AppDir

          tar -cJvf build/dist/naev-ndata.tar.xz -C staging/usr/share/naev dat

      - name: Upload Naev Binary Artifact
        uses: actions/upload-artifact@v3
        with:
          name: naev-steamruntime
          path: ${{ github.workspace }}/build/dist/naev.x64

      - name: Upload Naev Data Artifact
        uses: actions/upload-artifact@v3
        with:
          name: naev-ndata
          path: ${{ github.workspace }}/build/dist/naev-ndata.tar.xz

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: naev-linux-appdir-x86-64
          path: "${{ github.workspace }}/build/dist/naev-appdir.tar.xz"

  "Linux_Package_Release":
    needs:
      [
        Package_Source,
        Linux_Naev_Release
      ]
    runs-on: naev-release
    steps:
      - name: Get Packaging Assets
        uses: actions/download-artifact@v3
        with:
          name: naev-packaging-assets
          path: packaging

      - name: Get AppDir
        uses: actions/download-artifact@v3
        with:
          name: naev-linux-appdir-x86-64
          path: appdir

      - name: Package AppImage
        run: |
              chmod +x packaging/buildAppImage.sh
              tar -Jxf appdir/naev-appdir.tar.xz
              ./packaging/buildAppImage.sh -p -a "./AppDir" -b build

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: naev-linux-x86-64
          path: "${{ github.workspace }}/build/dist/*"

  "Windows_Naev_Release":
    needs: "Package_Source"

    strategy:
      fail-fast: false
      matrix:
        include:
          - image: naev-windows
            config: windows_cross_mingw.ini
            target: x86_64-pc-windows-gnu

    runs-on: ${{ matrix.image }}
    steps:
      - name: Configure Build Environment
        run: |
          /usr/bin/setup-devenv.sh

      - name: Get Source
        uses: actions/download-artifact@v3
        with:
          name: naev-dist

      - name: Extract Source
        run: |
          mkdir source
          tar -xf source.tar.xz -C source --strip 1

      - name: Cache Cargo home
        uses: actions/cache@v3
        with:
          path: build/cargo-home
          key: cargo-${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('source/Cargo.toml.in', 'source/meson.build') }}
          restore-keys: |
            cargo-${{ runner.os }}-${{ matrix.target }}-
            cargo-${{ runner.os }}-

      - name: Meson Setup
        # We disable b_lto here because it messes with backtraces on windows
        run: |
          meson setup build source \
              --prefix="$(pwd)"/build/windows \
              --bindir=. \
              -Dndata_path=. \
              --cross-file='source/utils/build/${{ matrix.config }}' \
              --native-file='source/utils/build/linux.ini' \
              --buildtype=release \
              --wrap-mode=nopromote \
              -Dinstaller=true \
              -Drelease=true \
              -Db_lto=false \
              -Dauto_features=enabled \
              -Ddocs_c=disabled \
              -Ddocs_lua=disabled

      - name: Meson Compile
        run: |
          meson compile -C build

      - name: Meson Install
        run: |
          meson install -C build

      - name: Upload Windows Installer Artifact
        uses: actions/upload-artifact@v3
        with:
          name: naev-win64-installer
          path: ${{ github.workspace }}/build/dist/naev-installer.exe
          if-no-files-found: error

      - name: Upload Windows Tarball Artifact
        uses: actions/upload-artifact@v3
        with:
          name: naev-win64-tarball
          path: ${{ github.workspace }}/build/dist/naev-windows.tar.xz
          if-no-files-found: error

  "Darwin_Compile_Naev":
    needs: "Package_Source"

    strategy:
      fail-fast: false
      matrix:
        include:
          - image: naev-macos
            arch: x86_64
            config: macos_cross_osxcross.ini
          - image: naev-macos
            arch: aarch64
            config: macos_aarch64_cross_osxcross.ini

    runs-on: ${{ matrix.image }}
    env:
      BUILDARCH: "${{ matrix.arch }}"
    steps:
      - name: Configure Build Environment
        run: |
          /usr/bin/setup-devenv.sh

      - name: Get Source
        uses: actions/download-artifact@v3
        with:
          name: naev-dist

      - name: Extract Source
        run: |
          mkdir source
          tar -xf source.tar.xz -C source --strip 1

      - name: Cache Cargo home
        uses: actions/cache@v3
        with:
          path: build/cargo-home
          key: cargo-${{ runner.os }}-${{ matrix.arch }}-${{ hashFiles('source/Cargo.toml.in', 'source/meson.build') }}
          restore-keys: |
            cargo-${{ runner.os }}-${{ matrix.arch }}-
            cargo-${{ runner.os }}-

      - name: Meson Setup
        run: |
          meson setup build source \
              --prefix="$(pwd)"/build/macos/Naev.app \
              --bindir=Contents/MacOS \
              --libdir=Contents/Frameworks \
              -Dndata_path=Contents/Resources \
              --cross-file='source/utils/build/${{ matrix.config }}' \
              --native-file='source/utils/build/linux.ini' \
              --buildtype=release \
              -Dinstaller=false \
              -Drelease=true \
              -Db_lto=true \
              -Dauto_features=enabled \
              -Ddocs_c=disabled \
              -Ddocs_lua=disabled

      - name: Meson Compile
        run: |
          meson compile -C build

      - name: Meson Install
        run: |
          meson install -C build

      - name: Fix zip name
        run: |
          mv build/dist/naev-macos.zip build/dist/naev-macos-${{ matrix.arch }}.zip

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: naev-macos-${{ matrix.arch }}
          path: ${{ github.workspace }}/build/dist/naev-macos-${{ matrix.arch }}.zip
          if-no-files-found: error

  "Darwin_Package_Release":
    needs:
      [
        Package_Source,
        Darwin_Compile_Naev
      ]
    runs-on: naev-macos

    steps:
      - name: Get Universal Bundle Packaging Script
        uses: actions/download-artifact@v3
        with:
          name: naev-packaging-assets
          path: packaging

      - name: Get x86_64 macOS Bundle
        uses: actions/download-artifact@v3
        with:
          name: naev-macos-x86_64

      - name: Get ARM64 macOS Bundle
        uses: actions/download-artifact@v3
        with:
          name: naev-macos-aarch64

      - name: Package Universal Bundle
        run: |
              mkdir -p arm64 x86_64
              chmod +x packaging/buildUniversalBundle.sh
              unzip naev-macos-aarch64.zip -d arm64
              unzip naev-macos-x86_64.zip -d x86_64
              ./packaging/buildUniversalBundle.sh -d -i ./packaging/dmg_assets -e ./packaging/entitlements.plist -a ./arm64 -x ./x86_64 -b ./build

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: naev-macos
          path: "${{ github.workspace }}/build/dist/*"

  "Steam_Naev_Soundtrack_Release":
    needs: "Package_Source"
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: naev-steamruntime
            config: linux_steamruntime.ini
            wrap_mode: default
            target: x86_64-unknown-linux-gnu

    runs-on: ${{ matrix.image }}

    steps:
      - name: Get Source
        uses: actions/download-artifact@v3
        with:
          name: naev-dist

      - name: Extract Source
        run: |
          mkdir source
          tar -xf source.tar.xz -C source --strip 1

      - name: Cache Cargo home
        uses: actions/cache@v3
        with:
          path: build/cargo-home
          key: cargo-${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('source/Cargo.toml.in', 'source/meson.build') }}
          restore-keys: |
            cargo-${{ runner.os }}-${{ matrix.target }}-
            cargo-${{ runner.os }}-

      - name: Meson Setup
        run: |
          meson setup build source \
              --native-file='source/utils/build/linux_steamruntime.ini' \
              --buildtype=release \
              --wrap-mode=${{ matrix.wrap_mode }} \
              --force-fallback-for=sdl2_image,glpk,SuiteSparse \
              -Dsteamruntime=true \
              -Dprefix="/usr" \
              -Dinstaller=true \
              -Db_lto=true \
              -Dauto_features=enabled \
              -Ddocs_c=disabled \
              -Ddocs_lua=disabled

      - name: Meson Compile
        run: |
          meson compile -C build soundtrack

      - name: Collect Artifacts
        run: |
          mkdir -p build/staging
          mkdir -p build/dist/steam

          unzip build/naev-*-soundtrack.zip -d build/staging
          cp build/naev-*-soundtrack.zip build/dist
          cp source/extras/logos/naev_soundtrack_cover.png build/dist/steam

      - name: Transcode Steam Soundtrack
        run: |
          ./source/utils/convertToMP3.sh -i build/staging -f ogg -o build/dist/steam

      - name: Upload Soundtrack Artifact
        uses: actions/upload-artifact@v3
        with:
          name: naev-soundtrack
          path: ${{ github.workspace }}/build/dist/naev-*-soundtrack.zip
          if-no-files-found: error

      - name: Upload Steam Soundtrack Artifact
        uses: actions/upload-artifact@v3
        with:
          name: naev-steam-soundtrack
          path: ${{ github.workspace }}/build/dist/steam/*
          if-no-files-found: error

  "Upload_Naev_Release":
    strategy:
      fail-fast: true
      matrix:
        include:
          - releasetype: codeberg
          - releasetype: steam
          - releasetype: itch

    runs-on: naev-release
    needs:
      [
        Package_Source,
        Linux_Package_Release,
        Windows_Naev_Release,
        Darwin_Package_Release,
        Steam_Naev_Soundtrack_Release,
      ]
    if: ${{ github.repository == 'naev/naev' }}

    steps:
      - name: Download Deployment Assets
        uses: actions/download-artifact@v3
        with:
          name: naev-deployment-assets
          path: ${{ github.workspace }}/build/staging/naev-deployment-assets

      - name: Download Version (codeberg/itch)
        if: ${{ matrix.releasetype == 'codeberg' || matrix.releasetype == 'itch' }}
        uses: actions/download-artifact@v3
        with:
          name: naev-version
          path: ${{ github.workspace }}/build/staging/naev-version

      - name: Download Changelog (codeberg)
        if: ${{ matrix.releasetype == 'codeberg' }}
        uses: actions/download-artifact@v3
        with:
          name: naev-changelog
          path: ${{ github.workspace }}/build/staging/naev-changelog

      - name: Download Source Tarball (codeberg)
        if: ${{ matrix.releasetype == 'codeberg' }}
        uses: actions/download-artifact@v3
        with:
          name: naev-dist
          path: ${{ github.workspace }}/build/staging/naev-dist

      - name: Download Linux Package (codeberg/itch)
        if: ${{ matrix.releasetype == 'codeberg' || matrix.releasetype == 'itch' }}
        uses: actions/download-artifact@v3
        with:
          name: naev-linux-x86-64
          path: ${{ github.workspace }}/build/staging/naev-linux-x86-64

      - name: Download Windows Installer (codeberg)
        if: ${{ matrix.releasetype == 'codeberg' }}
        uses: actions/download-artifact@v3
        with:
          name: naev-win64-installer
          path: ${{ github.workspace }}/build/staging/naev-win64

      - name: Download Windows Tarball (itch)
        if: ${{ matrix.releasetype == 'itch' }}
        uses: actions/download-artifact@v3
        with:
          name: naev-win64-tarball
          path: ${{ github.workspace }}/build/staging/naev-win64

      - name: Download macOS Package (codeberg/itch/steam)
        if: ${{ matrix.releasetype == 'codeberg' || matrix.releasetype == 'itch' || matrix.releasetype == 'steam' }}
        uses: actions/download-artifact@v3
        with:
          name: naev-macos
          path: ${{ github.workspace }}/build/staging/naev-macos

      - name: Download Soundtrack (codeberg/itch)
        if: ${{ matrix.releasetype == 'codeberg' || matrix.releasetype == 'itch' }}
        uses: actions/download-artifact@v3
        with:
          name: naev-soundtrack
          path: ${{ github.workspace }}/build/staging/naev-soundtrack

      - name: Download NDATA (itch/steam)
        if: ${{ matrix.releasetype == 'itch' || matrix.releasetype == 'steam' }}
        uses: actions/download-artifact@v3
        with:
          name: naev-ndata
          path: ${{ github.workspace }}/build/staging/naev-ndata

      - name: Download Steam Runtime Binary (steam)
        if: ${{ matrix.releasetype == 'steam' }}
        uses: actions/download-artifact@v3
        with:
          name: naev-steamruntime
          path: ${{ github.workspace }}/build/staging/naev-steamruntime

      - name: Download Linux AppDir (steam)
        if: ${{ matrix.releasetype == 'steam' }}
        uses: actions/download-artifact@v3
        with:
          name: naev-linux-appdir-x86-64
          path: ${{ github.workspace }}/build/staging/naev-linux-appdir-x86-64

      - name: Download Steam macOS Package (steam)
        if: ${{ matrix.releasetype == 'steam' }}
        uses: actions/download-artifact@v3
        with:
          name: naev-macos
          path: ${{ github.workspace }}/build/staging/naev-macos

      - name: Download Steam Windows Package (steam)
        if: ${{ matrix.releasetype == 'steam' }}
        uses: actions/download-artifact@v3
        with:
          name: naev-win64-tarball
          path: ${{ github.workspace }}/build/staging/naev-win64

      - name: Download Steam Soundtrack (steam)
        if: ${{ matrix.releasetype == 'steam' }}
        uses: actions/download-artifact@v3
        with:
          name: naev-steam-soundtrack
          path: ${{ github.workspace }}/build/staging/naev-steam-soundtrack

      - name: Force Codeberg over SSH
        run: git config --global url."ssh://git@codeberg.org/naev/".insteadOf https://codeberg.org/naev/
        if: ${{ matrix.releasetype == 'codeberg' }}

      - name: Checkout Naev Repository
        if: ${{ matrix.releasetype == 'codeberg' }}
        uses: actions/checkout@v4
        with:
          lfs: false
          submodules: false
          path: build/staging/repo
          ssh-key: ${{ secrets.CODEBERG_SSH_KEY }}
          ssh-known-hosts: ${{ secrets.CODEBERG_SSH_KNOWN_HOSTS }}
          persist-credentials: true

      - name: Generate Changelog
        if: ${{ matrix.releasetype == 'codeberg' }}
        working-directory: ${{ github.workspace }}/build/staging/repo
        run: |
          ./utils/ci/generate_release_notes.sh \
            --mode changelog \
            --tag "${{ github.ref_name }}" \
            --changelog "${GITHUB_WORKSPACE}/build/staging/naev-changelog/Changelog.md" \
            --output "${GITHUB_WORKSPACE}/build/staging/release_notes.md"

      - name: Stage Codeberg Release
        if: ${{ matrix.releasetype == 'codeberg' }}
        run: |
          chmod -R +x build/staging/naev-deployment-assets/berg
          cp -r build/staging/naev-deployment-assets/berg/* "$(pwd)"
          ./BergDeploy.sh -t "$(pwd)/build/staging" -o "$(pwd)/build/dist" -r "${{ github.ref_name }}"

      - name: Upload Codeberg Release
        if: ${{ matrix.releasetype == 'codeberg' }}
        working-directory: ${{ github.workspace }}/build/staging/repo
        run: |
          ./utils/ci/upload_codeberg_release.sh \
            --tag "${{ github.ref_name }}" \
            --notes-file "${GITHUB_WORKSPACE}/build/staging/release_notes.md" \
            --asset-dir "${GITHUB_WORKSPACE}/build/dist" \
            --prerelease \
            --overwrite \
            --owner naev \
            --repo naev \
            --api-url https://codeberg.org/api/v1
        env:
          CODEBERG_TOKEN: ${{ secrets.CODEBERG_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Upload itch.io Release
        if: ${{ matrix.releasetype == 'itch' }}
        run: |
          mv build/staging/naev-deployment-assets/itch build/staging/naev-itch-deployment
          chmod -R +x build/staging/naev-itch-deployment
          cp -r build/staging/naev-itch-deployment/. "$(pwd)"
          ./ItchDeploy.sh -t "$(pwd)/build/staging" -o "$(pwd)/build/dist"
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}

      - name: Build and Upload Steam Release
        if: ${{ matrix.releasetype == 'steam' }}
        run: |
          chmod -R +x build/staging/naev-deployment-assets/steam
          cp -r build/staging/naev-deployment-assets/steam/* "$(pwd)"
          ./SteamDeploy.sh -t "$(pwd)/build/staging" -o "$(pwd)/build/dist"
        env:
          STEAMCMD_USER: ${{ secrets.STEAMCMD_USER }}
          STEAMCMD_PASS: ${{ secrets.STEAMCMD_PASS }}
          TFA_IMAP: ${{ secrets.TFA_IMAP }}
          TFA_PASS: ${{ secrets.TFA_PASS }}
          TFA_USER: ${{ secrets.TFA_USER }}
