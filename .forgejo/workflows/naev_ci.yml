on: [push, pull_request]

name: CI

jobs:
  "Package_Source":
    runs-on: naev-release
    steps:
      - name: Checkout Naev Repository
        uses: actions/checkout@v4
        with:
          path: source
          submodules: true

      - name: Package Dist
        run: |
          meson setup build source -Dexecutable=disabled -Ddocs_c=disabled -Ddocs_lua=disabled --wrap-mode=forcefallback
          meson dist -C build --no-tests --include-subprojects

      - name: Upload Dist Artifact
        uses: actions/upload-artifact@v3
        with:
          name: naev-dist-${{ github.sha }}
          path: ${{ github.workspace }}/build/meson-dist/*

  "Linux_Compile_Naev":
    needs: "Package_Source"
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: naev-steamruntime
            config: linux_steamruntime.ini
            wrap_mode: default
            target: x86_64-unknown-linux-gnu

    runs-on: ${{ matrix.image }}

    steps:
      - name: Get Source
        uses: actions/download-artifact@v3
        with:
          name: naev-dist-${{ github.sha }}

      - name: Extract Source
        run: |
          mkdir source
          tar -xf naev-*.tar.xz -C source --strip 1

      - name: Meson Setup
        id: setup
        run: |
          meson setup build source \
              --native-file='source/utils/build/${{ matrix.config }}' \
              --buildtype=debug \
              --wrap-mode=${{ matrix.wrap_mode }} \
              --force-fallback-for=sdl2_image,glpk,SuiteSparse \
              -Dsteamruntime=false \
              -Dprefix="/usr" \
              -Db_lto=true \
              -Dinstaller=false \
              -Db_lto=true \
              -Dauto_features=enabled \
              -Ddocs_c=disabled \
              -Ddocs_lua=disabled

      - name: Upload Setup Log
        uses: actions/upload-artifact@v3
        if: ${{ success() || steps.setup.outcome == 'failure' }}
        with:
          name: ${{ matrix.image }}-${{ github.sha }}-setup-log
          path: ${{ github.workspace }}/build/meson-logs/meson-log.txt

      - name: Meson Compile
        id: compile
        run: |
          meson compile -C build

      - name: Upload Compile Log
        uses: actions/upload-artifact@v3
        if: ${{ success() || steps.compile.outcome == 'failure' }}
        with:
          name: ${{ matrix.image }}-${{ github.sha }}-compile-log
          path: ${{ github.workspace }}/build/meson-logs/meson-log.txt

      - name: Test Install
        id: install
        run: |
          meson install -C build
        env:
          DESTDIR: "${{ github.workspace }}/staging"

      - name: Upload Install Log
        uses: actions/upload-artifact@v3
        if: ${{ success() || steps.install.outcome == 'failure' }}
        with:
          name: ${{ matrix.image }}-${{ github.sha }}-install-log
          path: ${{ github.workspace }}/build/meson-logs/meson-log.txt

      - name: Compile AppImage
        id: appimageCompile
        run: |
          ./source/utils/buildAppImage.sh -d -i -s source -b appImageBuild | tee appImageBuildLog.txt

      - name: Upload AppImage Compile Log
        uses: actions/upload-artifact@v3
        if: ${{ (success() || steps.appimageCompile.outcome == 'failure') }}
        with:
          name: ${{ matrix.image }}-${{ github.sha }}-AppImageBuild-log
          path: ${{ github.workspace }}/appImageBuildLog.txt

  "Windows_Compile_Naev":
    needs: "Package_Source"

    strategy:
      fail-fast: false
      matrix:
        include:
          - image: naev-windows
            config: windows_cross_mingw.ini
            target: x86_64-pc-windows-gnu

    runs-on: ${{ matrix.image }}
    steps:
      - name: Configure Build Environment
        run: |
          # Print a message
          echo "Configuring the development environment"

          export CC_x86_64_pc_windows_gnu="clang --target=x86_64-pc-windows-gnu"

          export PKG_CONFIG_x86_64_pc_windows_gnu="x86_64-w64-mingw32-pkg-config"
          export PKG_CONFIG_SYSROOT_DIR_x86_64_pc_windows_gnu="/usr/x86_64-w64-mingw32/sys-root/mingw"
          export BINDGEN_EXTRA_CLANG_ARGS="--sysroot=/usr/x86_64-w64-mingw32/sys-root/mingw --target=x86_64-w64-mingw32"

          # If running in GitHub Actions or Forgejo Actions, persist env vars
          if [ "${GITHUB_ACTIONS:-}" = "true" ] && [ -n "${GITHUB_ENV:-}" ]; then
              echo "Running in GitHub/Forgejo Actions, exporting cross-compile vars to GITHUB_ENV"

              {
                  echo "CC_x86_64_pc_windows_gnu=${CC_x86_64_pc_windows_gnu}"
                  echo "PKG_CONFIG_x86_64_pc_windows_gnu=${PKG_CONFIG_x86_64_pc_windows_gnu}"
                  echo "PKG_CONFIG_SYSROOT_DIR_x86_64_pc_windows_gnu=${PKG_CONFIG_SYSROOT_DIR_x86_64_pc_windows_gnu}"
                  echo "BINDGEN_EXTRA_CLANG_ARGS=${BINDGEN_EXTRA_CLANG_ARGS}"
              } >> "$GITHUB_ENV"
          fi

      - name: Get Source
        uses: actions/download-artifact@v3
        with:
          name: naev-dist-${{ github.sha }}

      - name: Extract Source
        run: |
          mkdir source
          tar -xf naev-*.tar.xz -C source --strip 1

      - name: Meson Setup
        id: setup
        run: |
          meson setup build source \
              --prefix="$(pwd)"/source/extras/windows/installer \
              --bindir=bin \
              -Dndata_path=bin \
              --cross-file='source/utils/build/${{ matrix.config }}' \
              --native-file='source/utils/build/linux.ini' \
              --buildtype=debug \
              --wrap-mode=nopromote \
              -Dinstaller=false \
              -Drelease=false \
              -Db_lto=false \
              -Dauto_features=enabled \
              -Ddocs_c=disabled \
              -Ddocs_lua=disabled

      - name: Upload Setup Log
        uses: actions/upload-artifact@v3
        if: ${{ success() || steps.setup.outcome == 'failure' }}
        with:
          name: ${{ matrix.image }}-${{ github.sha }}-setup-log
          path: ${{ github.workspace }}/build/meson-logs/meson-log.txt

      - name: Meson Compile
        id: compile
        run: |
          meson compile -C build

      - name: Upload Compile Log
        uses: actions/upload-artifact@v3
        if: ${{ success() || steps.compile.outcome == 'failure' }}
        with:
          name: ${{ matrix.image }}-${{ github.sha }}-compile-log
          path: ${{ github.workspace }}/build/meson-logs/meson-log.txt

      - name: Test Install
        id: install
        run: |
          meson install -C build

      - name: Upload Install Log
        uses: actions/upload-artifact@v3
        if: ${{ success() || steps.install.outcome == 'failure' }}
        with:
          name: ${{ matrix.image }}-${{ github.sha }}-install-log
          path: ${{ github.workspace }}/build/meson-logs/meson-log.txt

  "Darwin_Compile_Naev":
    needs: "Package_Source"

    strategy:
      fail-fast: false
      matrix:
        include:
          - image: naev-macos
            arch: x86_64
            config: macos_cross_osxcross.ini
          - image: naev-macos
            arch: aarch64
            config: macos_aarch64_cross_osxcross.ini

    runs-on: ${{ matrix.image }}
    env:
      BUILDARCH: "${{ matrix.arch }}"

    steps:
      - name: Configure Build Environment
        run: |
          # Set HOST and MACOSX_DEPLOYMENT_TARGET depending on which BUILD_ARCH is selected.
          # Also configure the macports directory for the right libraries since we build for two different targets.

          # Pass in either BUILDARCH=aarch64 or BUILDARCH=x86_64 when starting this image to configure it correctly.

          # Print a message
          echo "Configuring the development environment"

          # Configure depending on BUILDARCH
          if [ "${BUILDARCH}" = "aarch64" ]; then
              export HOST="$BUILDARCH-apple-darwin23"
              export MACOSX_DEPLOYMENT_TARGET="${AARCH64_DEPLOYMENT_TARGET:-13.0}"
              export CARGO_TARGET_AARCH64_APPLE_DARWIN_LINKER="$HOST-cc"
              ln -sfn /usr/lib/osxcross/macports.aarch64 /usr/lib/osxcross/macports
          elif [ "${BUILDARCH}" = "x86_64" ]; then
              export HOST="$BUILDARCH-apple-darwin23"
              export MACOSX_DEPLOYMENT_TARGET="${X86_64_DEPLOYMENT_TARGET:-11.0}"
              export CARGO_TARGET_X86_64_APPLE_DARWIN_LINKER="$HOST-cc"
              ln -sfn /usr/lib/osxcross/macports.x86_64 /usr/lib/osxcross/macports
          else
              echo "Unknown or unset BUILDARCH='$BUILDARCH', defaulting to x86_64"
              export BUILDARCH="x86_64"
              export HOST="$BUILDARCH-apple-darwin23"
              export MACOSX_DEPLOYMENT_TARGET="${X86_64_DEPLOYMENT_TARGET:-}"
              export CARGO_TARGET_X86_64_APPLE_DARWIN_LINKER="$HOST-cc"
              ln -sfn /usr/lib/osxcross/macports.x86_64 /usr/lib/osxcross/macports
          fi

          # Configure pkg-config, bindgen
          export PKG_CONFIG="$HOST-pkg-config"
          export PKG_CONFIG_PATH="/usr/lib/osxcross/macports/pkgs/opt/local/lib/pkgconfig"
          export BINDGEN_EXTRA_CLANG_ARGS="--sysroot=/usr/lib/osxcross/SDK/MacOSX14.sdk --target=$BUILDARCH-apple-darwin"
          export CC_"$BUILDARCH"_apple_darwin="$HOST-cc"

          # If running in GitHub Actions or Forgejo Actions, persist env vars
          if [ "${GITHUB_ACTIONS:-}" = "true" ] && [ -n "${GITHUB_ENV:-}" ]; then
              echo "Running in GitHub/Forgejo Actions, exporting macOS cross-compile vars to GITHUB_ENV"

              {
                  echo "HOST=${HOST}"
                  echo "MACOSX_DEPLOYMENT_TARGET=${MACOSX_DEPLOYMENT_TARGET}"
                  echo "PKG_CONFIG=${PKG_CONFIG}"
                  echo "PKG_CONFIG_PATH=${PKG_CONFIG_PATH}"
                  echo "BINDGEN_EXTRA_CLANG_ARGS=${BINDGEN_EXTRA_CLANG_ARGS}"

                  # Cargo linker vars depending on arch
                  if [ "$BUILDARCH" = "aarch64" ]; then
                      echo "CARGO_TARGET_AARCH64_APPLE_DARWIN_LINKER=${CARGO_TARGET_AARCH64_APPLE_DARWIN_LINKER}"
                  elif [ "$BUILDARCH" = "x86_64" ]; then
                      echo "CARGO_TARGET_X86_64_APPLE_DARWIN_LINKER=${CARGO_TARGET_X86_64_APPLE_DARWIN_LINKER}"
                  fi

                  # CC var for build target
                  echo "CC_${BUILDARCH}_apple_darwin=${HOST}-cc"
              } >> "$GITHUB_ENV"
          fi

          # Print a "Ready to use" message
          echo "Ready to use for $HOST with MACOSX_DEPLOYMENT_TARGET=$MACOSX_DEPLOYMENT_TARGET"

      - name: Get Source
        uses: actions/download-artifact@v3
        with:
          name: naev-dist-${{ github.sha }}

      - name: Extract Source
        run: |
          mkdir source
          tar -xf naev-*.tar.xz -C source --strip 1

      - name: Meson Setup
        id: setup
        run: |
          meson setup build source \
              --prefix="$(pwd)"/build/dist/Naev.app \
              --bindir=Contents/MacOS \
              --libdir=Contents/Frameworks \
              -Dndata_path=Contents/Resources \
              --cross-file='source/utils/build/${{ matrix.config }}' \
              --native-file='source/utils/build/linux.ini' \
              --buildtype=debug \
              -Dinstaller=false \
              -Drelease=false \
              -Db_lto=true \
              -Dauto_features=enabled \
              -Ddocs_c=disabled \
              -Ddocs_lua=disabled


      - name: Upload Setup Log
        uses: actions/upload-artifact@v3
        if: ${{ success() || steps.setup.outcome == 'failure' }}
        with:
          name: ${{ matrix.image }}.${{ matrix.arch }}-${{ github.sha }}-setup-log
          path: ${{ github.workspace }}/build/meson-logs/meson-log.txt

      - name: Meson Compile
        id: compile
        run: |
          meson compile -C build

      - name: Upload Compile Log
        uses: actions/upload-artifact@v3
        if: ${{ success() || steps.compile.outcome == 'failure' }}
        with:
          name: ${{ matrix.image }}.${{ matrix.arch }}-${{ github.sha }}-compile-log
          path: ${{ github.workspace }}/build/meson-logs/meson-log.txt

      - name: Test Install
        id: install
        run: |
          meson install -C build

      - name: Upload Install Log
        uses: actions/upload-artifact@v3
        if: ${{ success() || steps.install.outcome == 'failure' }}
        with:
          name: ${{ matrix.image }}.${{ matrix.arch }}-${{ github.sha }}-install-log
          path: ${{ github.workspace }}/build/meson-logs/meson-log.txt

  "Luacheck":
    runs-on: naev-steamruntime
    needs:
      [
        Package_Source,
        Linux_Compile_Naev,
        Windows_Compile_Naev,
        Darwin_Compile_Naev,
      ]

    steps:
      - name: Get Source
        uses: actions/download-artifact@v3
        with:
          name: naev-dist-${{ github.sha }}

      - name: Extract Source
        run: |
          mkdir source
          tar -xf naev-*.tar.xz -C source --strip 1

      - name: Meson Setup
        id: setup
        run: |
          meson setup build source \
              --native-file='source/utils/build/linux.ini' \
              --buildtype=debug \
              -Dinstaller=false \
              -Db_lto=true \
              -Dauto_features=enabled \
              -Ddocs_c=disabled \
              -Ddocs_lua=disabled

      - name: Meson Compile
        id: compile
        run: |
          meson compile -C build

      - name: Meson Test
        id: test
        run: |
          meson test luacheck -C build

      - name: Upload Test Log
        uses: actions/upload-artifact@v3
        if: ${{ success() || steps.test.outcome == 'failure' }}
        with:
          name: ${{ github.sha }}-lualint-testlog
          path: ${{ github.workspace }}/build/meson-logs/testlog.txt

  "Documentation":
    runs-on: naev-docs
    needs: Luacheck

    steps:
      - name: Get Source
        uses: actions/download-artifact@v3
        with:
          name: naev-dist-${{ github.sha }}

      - name: Extract Source
        run: |
          mkdir source
          tar -xf naev-*.tar.xz -C source --strip 1

      - name: Meson Setup
        run: |
          meson setup build source \
              -Dexecutable=disabled

      - name: Meson Compile
        id: compile
        run: |
          meson compile -C build

      - name: Upload Compile Log
        uses: actions/upload-artifact@v3
        if: ${{ steps.compile.outcome == 'failure' }}
        with:
          name: ${{ github.sha }}-ldoc-log
          path: ${{ github.workspace }}/build/meson-logs/meson-log.txt

      - name: Trigger Website Build
        if: ${{ steps.compile.outcome == 'success' && github.ref == 'refs/heads/main' }}
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.WEBSITE_TOKEN }}" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            "https://codeberg.org/api/v1/repos/naev/naev-website/actions/workflows/api_build.yml/dispatches" \
            -d '{"ref": "main"}'
