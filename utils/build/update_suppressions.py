#!/usr/bin/env python3
"""
Utility script to update the Valgrind suppression file for Naev.
It runs ldd on the naev binary and generates suppression blocks for all dependencies.
"""

import os
import re
import subprocess
import sys
import argparse

ERROR_TYPES = [
   'Leak', 'Addr1', 'Addr2', 'Addr4', 'Addr8', 
   'Value1', 'Value2', 'Value4', 'Value8', 
   'Cond', 'Free', 'Overlap', 'Param'
]

GLOBAL_SUPPRESSIONS = [
   'ld-linux-x86-64.so*',
   'libnvidia*',
   'libGL*',
   'libX11*',
   'libwayland*',
   'libxcb*',
   'libdrm*',
   'libvulkan*',
   'libdbus*',
   'libpulse*',
   'libasound*',
   'libudev*',
   'libgbm*',
   'libEGL*',
   'libglapi*'
]

def main():
   parser = argparse.ArgumentParser(description='Update Valgrind suppression file.')
   parser.add_argument('--binary', required=True, help='Path to the naev binary.')
   parser.add_argument('--output', required=True, help='Path to the output suppression file.')
   args = parser.parse_args()

   if not os.path.exists(args.binary):
      print(f"Error: Binary not found at {args.binary}. Please build the project first.")
      sys.exit(1)

   print(f"Running ldd on {args.binary}...")
   try:
      ldd_output = subprocess.check_output(["ldd", args.binary], text=True)
   except subprocess.CalledProcessError as e:
      print(f"Error running ldd: {e}")
      sys.exit(1)

   libs = set()
   for line in ldd_output.splitlines():
      # Match library names in ldd output
      match = re.search(r'(lib[^\s]+\.so[^\s]*)', line)
      if match:
         lib_name = match.group(1).split('/')[-1]
         # Convert to wildcard pattern
         base_name = re.sub(r'\.so.*', '.so*', lib_name)
         libs.add(base_name)

   # Add global patterns
   for pattern in GLOBAL_SUPPRESSIONS:
      libs.add(pattern)

   sorted_libs = sorted(list(libs))

   print(f"Generating suppressions for {len(sorted_libs)} libraries at {args.output}...")
   with open(args.output, "w") as f:
      f.write("# Auto-generated Valgrind suppressions for Naev dependencies\n")
      f.write("# Generated by utils/build/update_suppressions.py\n\n")
      
      for lib in sorted_libs:
         clean_lib = lib.replace('.so*', '')
         for err in ERROR_TYPES:
            f.write("{\n")
            f.write(f"   suppress_{clean_lib}_{err}\n")
            f.write(f"   Memcheck:{err}\n")
            f.write("   ...\n")
            f.write(f"   obj:*/{lib}\n")
            f.write("}\n\n")

   print("Successfully updated suppression file.")

if __name__ == "__main__":
   main()
